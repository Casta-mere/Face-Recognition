1 引言
（设计该系统的动机+要解决的问题）
本文档旨在详细介绍系统，以便用户能够确认该项目的需求、人员能够根据需求设计编码。设计该系统的目的是提高实验室管理效率，方便实验室成员使用该系统签到或签退。由于使用人脸识别进行打卡，因此人脸等用户信息录入、人脸识别技术和打卡数据反馈等是设计本系统需要解决的主要问题。

2 需求分析与设计
2.1 需求分析
（将系统拆解为4个主要功能）
该系统可主要分为四个功能模块：录入信息、识别打卡、发送打卡数据和其他模块。使用该系统的用户可分为两种角色：管理员和普通用户。管理员可以录入信息、识别打卡、获取打卡数据和修改信息。普通用户可以使用识别打卡功能和获取打卡数据功能。

录入信息功能模块主要解决人脸等用户信息录入问题。录入人脸时，用户需要在指定框内完成摄像，摄像时需要露出五官，不能遮挡面部。填写信息时确保信息的有效性，如邮箱地址、电话号码等。录入信息后，系统会将信息存储在数据库中，以便后续识别打卡时使用。

识别打卡功能模块主要解决人脸识别问题，该模块放置在后台运行。一条打卡记录应至少包含用户ID、签到和签退时间和打卡状态。用户需要在指定时间内打卡打卡时人脸需对准摄像头，摄像头传递图像数据给后台，后台服务器负责识别匹配并反馈结果。系统会将所有用户的打卡情况存储在数据库中，以便后续发送打卡数据时使用。以下几种情况可能会导致打卡失败：
1、用户未签到且未签退
2、用户未签到但试图签退
3、用户已签到但未签退
4、用户未在指定时间内打卡
5、用户不存在
指定用户当天未签到时不能签退。如不在指定时间内打卡，需要等到指定时间内再打卡即可。如用户信息不存在，需要先录入信息，等到指定时间内再打卡。前三种情况将被标记为异常，这些数据将在一天打卡时间结束后记录到数据库中。

数据推送功能模块主要解决打卡数据反馈问题，同样放置在后台运行。打卡记录最多存放30（开发自定义）天，大于30天的记录将被自动清理。数据反馈的形式主要是从数据库获取数据，并输出为Excel表格，将表格发送至指定邮箱。该系统在每天签退时间结束时，也即22点，获取并输出当天所有的打卡记录，发送至管理员邮箱；每周一获取各用户上周的打卡记录并输出，发送至对应邮箱。


2.2 系统框架和流程
2.2.1 录入信息流程
2.2.2 识别打卡流程
2.2.3 发送打卡数据流程

（以上四个见svg图）

2.3 模块描述
（对2.2的简单描述）

系统初始状态下仅有管理员账号和密码信息，没有其他任何信息。此时需要使用管理员账号登录系统，选择录入信息模块增加用户信息，才能进行后续打卡操作。进入该模块后首先拍摄用户的图像，拍摄需按照标准进行，否则需要重新拍摄。拍摄成功后用户填写用户名、性别、手机号和邮箱等个人信息。填写好确认无误后提交，系统会随机分配ID，如果信息成功录入则提示成功录入并显示ID。若提示失败，用户需要从摄像开始重新执行流程。

识别打卡需要在指定时间段内完成。设定签到需要在早上6点到8点开放，签退功能在下午5点到晚上10点开放。识别打卡模块在后台自动运行。如果摄像头未开启，需要先开启摄像头（？）。识别到人脸，但不能匹配到ID，则提示没有此用户，打卡失败。如果匹配到ID，但未在签到/签退时间范围内，系统会提示不在时间段内，打卡失败；如果在时间范围内，需要判断此时是签到还是签退。如果是签到，直接记录打卡时间并存入数据库，提示打卡成功；如果是签退，首先需要判断用户是否有签到记录。如果有签到记录，记录签退时间并存入数据库，提示打卡成功；没有签到记录则提示无签到记录，打卡失败。

数据推送模块在后台自动运行。模块获取系统当前时间，判断当前时间是否已到22点，或判断时间是否已到周一。如果不满足任何一个条件，则等待一段时间后再次获取时间并判断（或者直接while true？）。如果当前时间满足22点，则获取当天所有用户的打卡记录，输出为Excel表格，发送至管理员邮箱。如果当天是周一，则需要判断本周是否已经发送周总数据给各用户。如果本周没有发送数据，则获取上周所有用户的打卡记录，输出为Excel表格，发送至对应邮箱，并标记本周已发送数据，防止重复发送。

2.4 设备支持
本系统使用摄像头完成人脸识别，摄像头需要网络模块与服务器通信。同时考虑安装简便问题(具体怎么安装？)，采用TP-LINK的鱼眼摄像头。该设备的规格参数如下：
（放个图片）
（图像与视频参数）
传感器类型：1/2.7英寸 CMOS
快门：1/25s-1/500s
视频编码标准：H.265/H.264
视频编码码率：64Kbps-2Mbps
焦距：1.1mm
镜头变焦类型：定焦
镜头光圈控制：固定
视频最大图像尺寸：1726x1726
视频主码流：1726x1726
视频子码流：704x704

（接口参数）
WiFi速率：2.4GHz 150Mbps
网络接口：RJ45 10/100Mbps
（网络功能）
支持协议：TCP/IP，ICMP，HTTP，DHCP，DNS等
（常规参数）
工作温度和湿度：-10℃~40℃，小于95%
功耗：5.4W MAX
尺寸：90mmx90mmx44mm
重量：0.1kg

2.5 可添加功能描述
考虑到时间有限，本系统以实现三个主模块为目标，如果在时间允许的情况下，可以添加以下功能：
1. 输出数据功能：可以按照时间范围或者用户ID筛选并输出指定打卡数据。
2. 修改个人信息功能：输入ID即可进行对应用户的信息进行修改。如果该用户不需要再使用打卡系统时，可删除该用户所有信息。
3. 设定打卡时间：输入指定时间段即可设定签到和签退时间段。
4. 查看异常情况：按照时间降序查看所有的异常打卡数据。
四个功能均需要管理员权限。

3 关键技术
本项目旨在完成人脸识别打卡系统，人脸识别是本项目的关键技术。人脸识别技术具体由三部分组成，分别是存放人脸数据的faceImg文件夹，添加人脸数据的addface函数和检测对比视频流人脸数据的detect_face函数。
第一个函数（addface()）是一个程序，用于向“faceImg”文件夹中添加新的人脸图像。该程序首先打开一个视频流，并使用OpenCV捕获视频流中的一帧。然后，程序将帧缩小为原始大小的1/4，将其转换为灰度图像，然后使用人脸检测算法检测图像中的人脸位置。如果未检测到任何人脸，则程序将退出。否则，程序将保存检测到的人脸图像，将其命名为“faceImg”文件夹中的下一个整数，并打印出新添加的人脸图像的文件名。
第二个函数（detect_faces()）是一个人脸识别程序，其功能是检测视频流中的人脸并识别它们是否属于已知人员。该程序首先读取一个名为“faceImg”的文件夹中的图像，并将每个图像中的人脸编码存储在known_face_encodings列表中，同时将每个人员的姓名存储在known_face_names列表中。然后，程序开始读取视频流中的帧，并使用人脸检测算法（face_recognition库）检测帧中的人脸位置。接着，程序将每个检测到的人脸编码与known_face_encodings中的编码进行比较，并找到与之最匹配的已知人员。如果匹配成功，程序将在视频流中绘制一个包围盒，并显示该人员的姓名和识别置信度。
